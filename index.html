<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Calculadora Premium</title>
<style>
  body {
    background:#121212;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:sans-serif;
    margin:0;
  }
  .calculator {
    background:#1e1e1e;
    padding:20px;
    border-radius:15px;
    width:420px;
    color:#fff;
    box-shadow:0 0 20px rgba(0,0,0,0.7);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .display {
    background:#000;
    color:#0ff;
    font-size:2rem;
    padding:15px;
    border-radius:10px;
    text-align:right;
    overflow-x:auto;
    white-space:nowrap;
  }
  .history-container {
    background:#111;
    border-radius:10px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    border:1px solid #222;
  }
  .history {
    color:#aaa;
    font-size:0.9rem;
    padding:10px;
    height:100px;
    overflow-y:auto;
    line-height:1.4;
  }
  .buttons {
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:10px;
  }
  button {
    padding:18px;
    font-size:1.05rem;
    border:none;
    border-radius:10px;
    cursor:pointer;
    background:#0056b3;
    color:#fff;
    user-select:none;
    transition:background 0.25s ease, box-shadow 0.25s ease;
  }
  button:hover {
    background:#007bff;
    box-shadow:0 0 12px rgba(0,123,255,0.6);
  }
  button:active {
    background:#003d80;
    animation: press 0.15s ease forwards;
  }
  @keyframes press {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    70% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  .equal { grid-row: span 2; background:#004c99; }
  .equal:hover { background:#339dff; }
  .zero { grid-column: span 2; }
  #clearHistoryBtn { font-size:0.9rem; }
  .spacer { visibility:hidden; pointer-events:none; }
</style>
</head>
<body>
<div class="calculator">
  <div class="display" id="display">0</div>

  <div class="history-container">
    <div class="history" id="history"></div>
  </div>

  <div class="buttons">
    <!-- Linha da memÃ³ria + clear all -->
    <button id="MC">MC</button>
    <button id="MR">MR</button>
    <button id="Mplus">M+</button>
    <button id="Mminus">M-</button>
    <button id="clearHistoryBtn">Clear All</button>

    <!-- Controles principais -->
    <button id="clear">C</button>
    <button id="backspace">âŒ«</button>
    <button>%</button>
    <button>/</button>
    <button id="mute">ðŸ”‡</button>

    <!-- Linha 7-9, *, âˆš -->
    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button>*</button>
    <button id="sqrt">âˆš</button>

    <!-- Linha 4-6, -, = (comeÃ§a aqui e ocupa 2 linhas) -->
    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button>-</button>
    <button class="equal">=</button>

    <!-- Linha 1-3, + (o = continua ocupando a 5Âª coluna) -->
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button>+</button>

    <!-- Ãšltima linha: 0, vÃ­rgula e espaÃ§adores para fechar a grade -->
    <button class="zero">0</button>
    <button>,</button>
    <button class="spacer" aria-hidden="true" tabindex="-1"></button>
    <button class="spacer" aria-hidden="true" tabindex="-1"></button>
  </div>
</div>

<script>
  const display = document.getElementById("display");
  const historyBox = document.getElementById("history");

  let soundEnabled = true;
  let justCalculated = false;        // se acabou de calcular (= ou âˆš)
  let lastOperator = null;           // para repetiÃ§Ã£o de operaÃ§Ã£o no "="
  let lastOperand = null;
  let memoryValue = 0;               // memÃ³ria (MC/MR/M+/M-)

  // Som via Web Audio API
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(){
    if(!soundEnabled) return;
    if(audioCtx.state === "suspended") audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.value = 440;
    gain.gain.value = 0.1;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.08);
  }

  function isOperator(ch){ return "+-*/".includes(ch); }
  function lastSegment(text){
    const parts = text.split(/([+\-*/])/);
    return parts[parts.length - 1] || "";
  }

  function updateDisplay(val){
    const text = display.textContent;

    // ApÃ³s cÃ¡lculo: nÃºmero/',' comeÃ§a novo; operador continua do resultado
    if (justCalculated) {
      if (isOperator(val)) {
        display.textContent = text + val;
      } else if (val === ",") {
        display.textContent = "0,";
      } else {
        display.textContent = val;
      }
      justCalculated = false;
      return;
    }

    if (text === "Erro") {
      if (val === ",") display.textContent = "0,";
      else if (isOperator(val)) display.textContent = "0" + val;
      else display.textContent = val;
      return;
    }

    // Evitar duas vÃ­rgulas no mesmo nÃºmero
    if (val === ",") {
      if (lastSegment(text).includes(",")) return;
      if (text === "0") { display.textContent = "0,"; return; }
    }

    // Substituir operador se o Ãºltimo char for operador
    const last = text.slice(-1);
    if (isOperator(val) && isOperator(last)) {
      display.textContent = text.slice(0, -1) + val;
      return;
    }

    // Remover zero Ã  esquerda em novo nÃºmero
    if (text === "0" && !isOperator(val) && val !== ",") {
      display.textContent = val;
      return;
    }

    display.textContent += val;
  }

  function toEval(expr){ return expr.replace(/,/g,"."); }
  function fromEval(num){ return num.toString().replace(/\./g,","); }

  function calculate(){
    try{
      const expr = toEval(display.textContent);
      if (/[+\-*/.]$/.test(expr)) return;

      let result;
      if (justCalculated && lastOperator && lastOperand !== null) {
        // Repetir Ãºltima operaÃ§Ã£o sobre o resultado atual
        const current = parseFloat(display.textContent.replace(",", "."));
        result = eval(current + lastOperator + lastOperand);
      } else {
        // CÃ¡lculo normal e captura da Ãºltima operaÃ§Ã£o
        result = eval(expr);
        const match = expr.match(/([+\-*/])([^+\-*/]+)$/);
        if (match) {
          lastOperator = match[1];
          lastOperand = parseFloat(match[2]);
        } else {
          lastOperator = null;
          lastOperand = null;
        }
      }

      if (result === undefined || result === null || isNaN(result)) {
        display.textContent = "Erro";
        justCalculated = false;
        return;
      }

      const formatted = fromEval(result);
      addToHistory(display.textContent + " = " + formatted);
      display.textContent = formatted;
      justCalculated = true;
    } catch {
      display.textContent = "Erro";
      justCalculated = false;
    }
  }

  function clearDisplay(){
    display.textContent = "0";
    justCalculated = false;
    lastOperator = null;
    lastOperand = null;
  }

  function backspace(){
    if (justCalculated) { clearDisplay(); return; }
    display.textContent = display.textContent.slice(0, -1) || "0";
  }

  function percent(){
    const n = parseFloat(display.textContent.replace(",", "."));
    if (!isNaN(n)) {
      display.textContent = (n/100).toString().replace(".", ",");
      justCalculated = false;
    }
  }

  function sqrt(){
    let n = parseFloat(display.textContent.replace(",", "."));
    if (!isNaN(n) && n >= 0) {
      const res = Math.sqrt(n);
      const formatted = res.toString().replace(".", ",");
      addToHistory("âˆš(" + display.textContent + ") = " + formatted);
      display.textContent = formatted;
      justCalculated = true;
      // ApÃ³s sqrt, nÃ£o repetir operaÃ§Ã£o anterior
      lastOperator = null;
      lastOperand = null;
    } else {
      display.textContent = "Erro";
      justCalculated = false;
    }
  }

  function clearAll(){
    historyBox.innerHTML = "";
    clearDisplay();
  }

  function addToHistory(entry){
    const div = document.createElement("div");
    div.textContent = entry;
    historyBox.prepend(div);
  }

  // MemÃ³ria
  function memoryClear(){ memoryValue = 0; }
  function memoryRecall(){
    display.textContent = fromEval(memoryValue);
    justCalculated = true; // prÃ³ximo dÃ­gito inicia nova entrada
  }
  function memoryAdd(){
    const n = parseFloat(display.textContent.replace(",", ".") || "0");
    if (!isNaN(n)) memoryValue += n;
  }
  function memorySubtract(){
    const n = parseFloat(display.textContent.replace(",", ".") || "0");
    if (!isNaN(n)) memoryValue -= n;
  }

  // Clique nos botÃµes
  document.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      playSound();
      const v = btn.textContent;

      if (btn.id === "clear") clearDisplay();
      else if (btn.id === "backspace") backspace();
      else if (btn.id === "sqrt") sqrt();
      else if (btn.id === "mute"){ soundEnabled = !soundEnabled; btn.textContent = soundEnabled ? "ðŸ”Š" : "ðŸ”‡"; }
      else if (btn.id === "clearHistoryBtn"){ clearAll(); }
      else if (btn.id === "MC") memoryClear();
      else if (btn.id === "MR") memoryRecall();
      else if (btn.id === "Mplus") memoryAdd();
      else if (btn.id === "Mminus") memorySubtract();
      else if (v === "=") calculate();
      else if (v === "%") percent();
      else updateDisplay(v);
    });
  });

  // Teclado fÃ­sico
  document.addEventListener("keydown",(e)=>{
    const k = e.key;

    if (!isNaN(k) || "+-*/".includes(k)) { updateDisplay(k); playSound(); }
    else if (k === "Enter") { e.preventDefault(); calculate(); playSound(); }
    else if (k === "Backspace") { backspace(); playSound(); }
    else if (k.toUpperCase() === "C") { clearDisplay(); playSound(); }
    else if (k === "%") { percent(); playSound(); }
    else if (k === "." || k === ",") { updateDisplay(","); playSound(); }
    else if (k.toLowerCase() === "r") { sqrt(); playSound(); }
    else if (k.toLowerCase() === "m") { soundEnabled = !soundEnabled; document.getElementById("mute").textContent = soundEnabled ? "ðŸ”Š" : "ðŸ”‡"; }
    else if (k.toLowerCase() === "h" || k === "Escape") { clearAll(); }
    // Atalhos simples de memÃ³ria (opcionais):
    else if (k.toLowerCase() === "q") { memoryClear(); }     // MC
    else if (k.toLowerCase() === "w") { memoryRecall(); }    // MR
    else if (k.toLowerCase() === "e") { memoryAdd(); }       // M+
    else if (k.toLowerCase() === "a") { memorySubtract(); }  // M-
  });
</script>
</body>
</html>
